<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Senhas Pendentes</title>
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#ffffff">
    <style>
        /* Bloqueando o scroll da p√°gina */
        body, html {
            height: 100%;
            overflow: hidden; /* Impede o scroll */
            margin: 0;
        }
        
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .senha{
            font-size: 32px;
            color: #FF5733;
            margin-bottom: 20px;
            text-align: center;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.1), -5px -5px 15px rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            overflow: hidden;
        }
        th, td {
            padding: 12px;
            text-align: center;
        }
        th {
            background-color: #4CAF50;
            color: white;
        }
        td {
            background-color: #fff;
            color: #333;
        }
        button {
            padding: 15px 30px;
            font-size: 16px;
            background-color: #FF5733;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: 4px 4px 6px rgba(0, 0, 0, 0.1), -4px -4px 6px rgba(255, 255, 255, 0.5);
            transition: transform 0.2s;
        }
        button:hover {
            transform: scale(1.05);
        }
        /* Fixando o bot√£o no canto superior direito */
        .chamar-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10;
        }

        /* Estilos para o overlay de carregamento */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
            visibility: hidden;
        }

        .loading-overlay.active {
            visibility: visible;
        }

        .loading-spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
        }

        /* Painel para chamadas concorrentes (modo split) */
        .concorrentes-container {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 360px;
            background: rgba(255,255,255,0.95);
            box-shadow: 0 4px 18px rgba(0,0,0,0.12);
            border-radius: 14px;
            padding: 12px;
            z-index: 1200;
            display: none;
        }
        .concorrentes-title {
            font-weight: 700;
            color: #444;
            font-size: 0.95em;
            margin-bottom: 8px;
        }
        .concorrentes-cards {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 8px;
        }
        .concorrente-card {
            background: linear-gradient(135deg, #eef2ff 0%, #f8fbff 100%);
            border: 1px solid #e0e7ff;
            border-radius: 10px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-height: 88px;
        }
        .concorrente-senha {
            font-size: 1.3em;
            font-weight: 800;
            color: #3949ab;
        }
        .concorrente-operador {
            font-size: 0.95em;
            color: #555;
        }
        .concorrente-hora {
            font-size: 0.8em;
            color: #777;
        }
        .btn-disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Tabela de pr√≥ximas senhas com altura fixa e rolagem interna */
        #tabela-senhas-container {
            max-height: 350px;
            overflow-y: auto;
            margin-bottom: 20px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        #tabela-senhas {
            margin-bottom: 0;
        }

        /* Cards fixos no rodap√© */
        #cards-atendimento-fixed {
            position: fixed;
            left: 0;
            bottom: 0;
            width: 100vw;
            background: #fff;
            box-shadow: 0 -2px 12px rgba(0,0,0,0.10);
            z-index: 100;
            padding: 16px 0 8px 0;
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .card-atendimento {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            padding: 18px 28px;
            min-width: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        
        .btn-chamar-novamente {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.2s;
        }
        
        .btn-chamar-novamente:hover {
            background: #218838;
            transform: scale(1.05);
        }
        body { padding-bottom: 120px; } /* espa√ßo para n√£o cobrir conte√∫do */
        .alerta-preferenciais {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            background: #ffeb3b;
            color: #b71c1c;
            font-weight: bold;
            font-size: 1.3em;
            text-align: center;
            z-index: 9999;
            padding: 18px 0 14px 0;
            box-shadow: 0 2px 12px rgba(0,0,0,0.13);
            display: none;
        }
        .alerta-preferenciais .close-alerta {
            position: absolute;
            right: 24px;
            top: 10px;
            font-size: 1.2em;
            color: #b71c1c;
            background: none;
            border: none;
            cursor: pointer;
        }
        
        /* Estilos para o card da senha atual */
        .senha-atual-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .senha-atual-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            pointer-events: none;
        }
        
        .senha-atual-content {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 30px;
        }
        
        .operador-info {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
        }
        
        .operador-foto {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .operador-foto img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .avatar-placeholder {
            font-size: 40px;
            color: rgba(255,255,255,0.7);
        }
        
        .operador-detalhes {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .operador-nome {
            font-size: 1.4em;
            font-weight: bold;
            color: white;
        }
        
        .operador-status {
            font-size: 0.9em;
            color: rgba(255,255,255,0.8);
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 15px;
            display: inline-block;
            width: fit-content;
        }
        
        /* Estilos para o popup do pedido */
        .pedido-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .pedido-popup-content {
            background: white;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .pedido-popup-header {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .pedido-popup-header h2 {
            margin: 0;
            font-size: 1.4em;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 2em;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }
        
        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .pedido-popup-body {
            padding: 25px;
        }
        
        .senha-info-popup {
            background: #e9ecef;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            border-left: 5px solid #28a745;
        }
        
        .senha-number-popup {
            font-size: 3em;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
        }
        
        .senha-setor-popup {
            color: #666;
            font-size: 1.2em;
            font-weight: 500;
        }
        
        .pedido-content h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .pedido-text {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #28a745;
            line-height: 1.6;
            color: #333;
            font-size: 1em;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .pedido-popup-footer {
            padding: 20px;
            text-align: center;
            border-top: 1px solid #e9ecef;
        }
        
        .confirm-btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .confirm-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }
        
        .senha-info {
            text-align: right;
            flex-shrink: 0;
        }
        
        .senha-label {
            font-size: 0.9em;
            color: rgba(255,255,255,0.8);
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .senha-numero {
            font-size: 3em;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        /* Estilos para o bot√£o Ver Pedido */
        .btn-ver-pedido {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }
        
        .btn-ver-pedido:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
            background: linear-gradient(45deg, #ee5a24, #ff6b6b);
        }
        
        .btn-ver-pedido:active {
            transform: translateY(0);
        }
        
        /* Responsividade para o card da senha atual */
        @media (max-width: 768px) {
            .senha-atual-content {
                flex-direction: column;
                text-align: center;
                gap: 20px;
            }
            
            .operador-info {
                flex-direction: column;
                gap: 15px;
            }
            
            .senha-info {
                text-align: center;
            }
            
            .senha-numero {
                font-size: 2.5em;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.js"></script>
    <script>
        // Conectar ao Socket.IO
        var socket = io();

        // Estados de controle
        let chamadaEmProgresso = false;
        let timeoutChamada = null;
        let ultimaSenhaConhecida = null;
        let atualizandoSenha = false;
        const TEMPO_TIMEOUT_CHAMADA = 12000; // 12s de seguran√ßa
        const TEMPO_EXIBICAO_CONCORRENTE = 1800; // ms
        let filaConcorrentes = [];
        let exibindoConcorrentes = false;
        // Fila para serializar chamadas e evitar simultaneidade
        const filaChamadas = [];
        let processandoFila = false;
        let pendenteAtualResolver = null;
        
        // Fun√ß√£o para pegar cookie
        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }
        
        // Entrar na sala do setor quando conectar
        socket.on('connect', function() {
            console.log('[SOCKET] Conectado ao servidor');
            
            // Pegar o setor_id do cookie
            var setorId = getCookie('setor_id');
            if (setorId) {
                socket.emit('join_setor', { setor_id: setorId });
                console.log('[SOCKET] Entrando na sala do setor:', setorId);
            }
        });
        
        socket.on('joined_setor', function(data) {
            console.log('[SOCKET] Entrou na sala do setor:', data.setor_id);
        });

        const tabelaBody = document.getElementById('tabela-senhas-body');
        socket.on('atualizar_lista', (data) => {
            console.log('Evento atualizar_lista recebido:', data);
            // Atualiza a senha atual
            var elAtual = document.querySelector('.senha-atual');
            if (elAtual) elAtual.textContent = `Senha Atual: ${data.senha_atual}`;
            
            // Atualizar o card da senha atual
            atualizarSenha();
            
            var tabelaBody = document.getElementById('tabela-senhas-body');
            if (tabelaBody) {
                tabelaBody.innerHTML = '';
                if (data.senhas && data.senhas.length === 0) {
                    tabelaBody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#888;font-size:1.2em;">Sem senhas pendentes</td></tr>';
                } else if (data.senhas) {
                    data.senhas.forEach(senha => {
                        const linha = `<tr>
                            <td>${senha[0]}</td>
                            <td>${senha[1]}</td>
                            <td>${senha[2]}</td>
                        </tr>`;
                        tabelaBody.innerHTML += linha;
                    });
                }
            }
        });
        
        socket.on('nova_senha_para_avaliacao', function(data) {
            console.log('Evento nova_senha_para_avaliacao recebido:', data);
            atualizarSenha();
        });
        
        socket.on('atualizar_atendimentos', function(data) {
            console.log('Evento atualizar_atendimentos recebido:', data);
            atualizarSenha();
        });

        socket.on('erro', (data) => {
            // Handle error
        });

        function setBotoesChamadaDisabled(disabled) {
            document.querySelectorAll('.chamar-btn button, #formOperador button[type="submit"]').forEach(btn => {
                btn.disabled = disabled;
                btn.classList.toggle('btn-disabled', disabled);
            });
        }

        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
            setBotoesChamadaDisabled(true);
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
            setBotoesChamadaDisabled(false);
        }

        function iniciarChamada() {
            if (chamadaEmProgresso) return;
            chamadaEmProgresso = true;
            showLoading();
            clearTimeout(timeoutChamada);
            timeoutChamada = setTimeout(() => {
                console.warn('[CHAMADA] Timeout atingido, liberando UI');
                finalizarChamada(false);
            }, TEMPO_TIMEOUT_CHAMADA);
        }

        function finalizarChamada(ok = true) {
            if (!chamadaEmProgresso) return;
            chamadaEmProgresso = false;
            clearTimeout(timeoutChamada);
            hideLoading();
            if (!ok) {
                console.warn('[CHAMADA] Finalizada com alerta/timeout');
            }
        }

        function resolverPendente(ok = true) {
            if (pendenteAtualResolver) {
                const resolver = pendenteAtualResolver;
                pendenteAtualResolver = null;
                resolver(ok);
            }
        }

        // Fila para serializar disparos de chamadas
        function enfileirarChamada(acao) {
            filaChamadas.push(acao);
            processarFilaChamadas();
        }

        function processarFilaChamadas() {
            if (processandoFila) return;
            if (filaChamadas.length === 0) return;
            processandoFila = true;
            const acao = filaChamadas.shift();
            executarAcaoFila(acao)
                .catch(err => console.error('[FILA] Erro na a√ß√£o:', err))
                .finally(() => {
                    processandoFila = false;
                    processarFilaChamadas();
                });
        }

        function executarAcaoFila(acao) {
            return new Promise((resolve) => {
                let timeoutFila = null;
                const concluir = (ok) => {
                    if (timeoutFila) clearTimeout(timeoutFila);
                    pendenteAtualResolver = null;
                    finalizarChamada(ok);
                    resolve();
                };
                pendenteAtualResolver = concluir;

                // Timeout de seguran√ßa adicional para fila
                timeoutFila = setTimeout(() => {
                    console.warn('[FILA] Timeout fila atingido');
                    concluir(false);
                }, TEMPO_TIMEOUT_CHAMADA);

                if (acao.tipo === 'proxima') {
                    iniciarChamada();
                    fetch('/chamar_proxima', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: new URLSearchParams({ operador_id: acao.operadorId })
                    })
                    .then(res => {
                        if (!res.ok) throw new Error('Resposta HTTP n√£o OK');
                        return res.json().catch(() => ({}));
                    })
                    .catch(err => {
                        console.error('[FILA] Erro ao chamar pr√≥xima:', err);
                        concluir(false);
                    });
                } else if (acao.tipo === 'repetir') {
                    iniciarChamada();
                    fetch('/chamar_senha_novamente', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            senha: acao.senha,
                            operador_id: acao.operadorId
                        })
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data && data.success) {
                            var audio = new Audio('/static/msc/audio.mp3');
                            audio.play();
                            // Aguarda confirma√ß√£o via socket/atualizarSenha; se n√£o vier, timeout cuida
                            setTimeout(() => {
                                if (pendenteAtualResolver) {
                                    pendenteAtualResolver(true);
                                }
                            }, 1500);
                        } else {
                            throw new Error(data && data.error ? data.error : 'Erro ao chamar novamente');
                        }
                    })
                    .catch(err => {
                        console.error('[FILA] Erro ao chamar novamente:', err);
                        concluir(false);
                    });
                } else {
                    console.warn('[FILA] A√ß√£o desconhecida');
                    concluir(false);
                }
            });
        }

        function registrarChamadaConcorrente(info) {
            if (!info || !info.senha) return;
            // Evitar duplicados imediatos
            const jaFila = filaConcorrentes.some(i => i.senha === info.senha && i.operador === info.operador);
            if (!jaFila) filaConcorrentes.push(info);
            if (!exibindoConcorrentes) {
                processarConcorrentes();
            }
        }

        function processarConcorrentes() {
            const painel = document.getElementById('painelConcorrentes');
            const cards = document.getElementById('concorrentesCards');
            if (!painel || !cards) return;
            if (filaConcorrentes.length === 0) {
                painel.style.display = 'none';
                exibindoConcorrentes = false;
                return;
            }

            exibindoConcorrentes = true;
            const lote = filaConcorrentes.splice(0, 2); // split em at√© 2
            cards.innerHTML = '';
            lote.forEach(item => {
                const div = document.createElement('div');
                div.className = 'concorrente-card';
                div.innerHTML = `
                    <div class="concorrente-senha">${item.senha}</div>
                    <div class="concorrente-operador">${item.operador || 'Operador'}</div>
                    <div class="concorrente-hora">${item.hora || ''}</div>
                `;
                cards.appendChild(div);
            });
            painel.style.display = 'block';

            setTimeout(() => {
                processarConcorrentes();
            }, TEMPO_EXIBICAO_CONCORRENTE);
        }
    </script>
</head>
<body>
    
    <h1>Senhas Pendentes</h1>

    <!-- Painel de chamadas concorrentes (split) -->
    <div id="painelConcorrentes" class="concorrentes-container">
        <div class="concorrentes-title">Chamadas simult√¢neas</div>
        <div id="concorrentesCards" class="concorrentes-cards"></div>
    </div>

    <!-- Card da senha atual com foto do operador -->
    <div class="senha-atual-card" id="senha-atual-card" style="display: none;">
        <div class="senha-atual-content">
            <div class="operador-info">
                <div class="operador-foto" id="operador-foto">
                    <div class="avatar-placeholder">üë§</div>
                </div>
                <div class="operador-detalhes">
                    <div class="operador-nome" id="operador-nome">Operador</div>
                    <div class="operador-status">Atendendo agora</div>
                </div>
            </div>
            <div class="senha-info">
                <div class="senha-label">Senha Atual</div>
                <div class="senha-numero" id="senha-display">Carregando...</div>
                <!-- Bot√£o Ver Pedido (aparece apenas se tem_pedido = true) -->
                <button id="btn-ver-pedido" class="btn-ver-pedido" style="display: none;" onclick="verPedidoAtual()">
                    üìã Ver Pedido
                </button>
            </div>
        </div>
    </div>
    
    <div class="senha-atual" style="display: none;"></div>
    <!-- Tabela de pr√≥ximas senhas com altura fixa -->
    <div id="tabela-senhas-container">
        <table id="tabela-senhas">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Senha</th>
                    <th>Tipo</th>
                </tr>
            </thead>
            <tbody id="tabela-senhas-body">
                {% if senhas and senhas|length > 0 %}
                    {% for s in senhas %}
                    <tr>
                        <td>{{ s[0] }}</td>
                        <td>{{ s[1] }}</td>
                        <td>{{ s[2] }}</td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr><td colspan="3" style="text-align:center;color:#888;font-size:1.2em;">Sem senhas pendentes</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>
    
    <!-- Bot√£o fixo no canto superior direito -->
    <div class="chamar-btn">
        <button onclick="abrirModalOperador()">Chamar Pr√≥xima Senha</button>
        <!-- Bot√£o de teste para notifica√ß√£o -->
        <button onclick="testarNotificacao()" style="background: #ff6b6b; margin-left: 10px; display: none;" >üß™ Testar Notifica√ß√£o</button>
    </div>

    <!-- Modal de identifica√ß√£o do operador -->
    <div id="modalOperador" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center;">
        <div style="background:#fff;padding:30px;border-radius:10px;max-width:350px;margin:auto;">
            <h2>Selecione o Operador</h2>
            <form id="formOperador" method="POST" action="/chamar_proxima">
                <div style="display:flex;flex-direction:column;gap:10px;">
                {% for op in operadores %}
                    <button type="submit" name="operador_id" value="{{ op[0] }}" style="padding:15px;font-size:1.2em;border-radius:8px;background:#007BFF;color:#fff;border:none;display:flex;align-items:center;gap:10px;justify-content:center;">
                        {% if op[2] %}
                            <img src="/uploads/{{ op[2] }}" alt="Foto de {{ op[1] }}" style="width: 30px; height: 30px; border-radius: 50%; object-fit: cover; border: 2px solid #fff;">
                        {% else %}
                            <div style="width: 30px; height: 30px; border-radius: 50%; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border: 2px solid #fff;">
                                <span style="font-size: 16px; color: #999;">üë§</span>
                            </div>
                        {% endif %}
                        {{ op[1] }}
                    </button>
                {% endfor %}
                </div>
                <button type="button" onclick="fecharModalOperador()" style="width:100%;margin-top:10px;background:#ccc;">Cancelar</button>
            </form>
        </div>
    </div>
    <script>
        function abrirModalOperador() {
            document.getElementById('modalOperador').style.display = 'flex';
        }
        function fecharModalOperador() {
            document.getElementById('modalOperador').style.display = 'none';
        }
    </script>

    <!-- Overlay de carregamento -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <script>
        // Submeter chamada via fetch para evitar reload e controlar loading
        document.addEventListener('DOMContentLoaded', function() {
            const formOperador = document.getElementById('formOperador');
            if (formOperador) {
                formOperador.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const btn = e.submitter;
                    const operadorId = btn ? btn.value : null;
                    if (!operadorId) {
                        console.warn('[CHAMAR] operador_id n√£o encontrado');
                        return;
                    }
                    enfileirarChamada({ tipo: 'proxima', operadorId });
                    fecharModalOperador();
                });
            }
        });
        function atualizarSenha() {
          if (atualizandoSenha) {
            console.log('J√° est√° atualizando, ignorando...');
            return;
          }
          
          atualizandoSenha = true;
          console.log('Atualizando senha...');
          
          fetch('/get_senha_atual_setor')
            .then(response => response.json())
            .then(data => {
              console.log('Dados recebidos:', data);
              var elSenha = document.getElementById('senha-display');
              var elOperador = document.getElementById('operador-nome');
              var elFoto = document.getElementById('operador-foto');
              var elCard = document.getElementById('senha-atual-card');
              var elBtnVerPedido = document.getElementById('btn-ver-pedido');
              
              console.log('Elementos encontrados:', {
                senha: !!elSenha,
                operador: !!elOperador,
                foto: !!elFoto,
                card: !!elCard,
                btnVerPedido: !!elBtnVerPedido
              });
              
              // Verificar se √© uma nova senha
              const senhaAtual = data.senha_atual || 'Nenhuma';
              const novaSenha = ultimaSenhaConhecida !== null && ultimaSenhaConhecida !== senhaAtual;
              
              if (elSenha) elSenha.innerText = senhaAtual;
              
              if (data.operador && data.operador !== '') {
                console.log('Operador encontrado:', data.operador);
                if (elOperador) elOperador.innerText = data.operador;
                if (elCard) {
                  elCard.style.display = 'block';
                  console.log('Card da senha atual exibido');
                }
                
                // Atualizar foto do operador
                if (elFoto) {
                  if (data.foto_operador) {
                    elFoto.innerHTML = `<img src="/uploads/${data.foto_operador}" alt="Foto de ${data.operador}">`;
                  } else {
                    elFoto.innerHTML = '<div class="avatar-placeholder">üë§</div>';
                  }
                }
                
                // Controlar visibilidade do bot√£o "Ver Pedido"
                if (elBtnVerPedido) {
                  console.log('Verificando se deve mostrar bot√£o Ver Pedido:', {
                    tem_pedido: data.tem_pedido,
                    pedido: data.pedido
                  });
                  
                  if (data.tem_pedido && data.pedido) {
                    elBtnVerPedido.style.display = 'inline-block';
                    console.log('‚úÖ Bot√£o Ver Pedido exibido');
                  } else {
                    elBtnVerPedido.style.display = 'none';
                    console.log('‚ùå Bot√£o Ver Pedido oculto');
                  }
                }
              } else {
                console.log('Nenhum operador ativo');
                if (elCard) elCard.style.display = 'none';
                if (elBtnVerPedido) elBtnVerPedido.style.display = 'none';
              }
              
              // Toca o som APENAS quando for uma nova senha
              if (novaSenha && senhaAtual !== 'Nenhuma' && senhaAtual !== 'Aguardando pr√≥xima senha...') {
                console.log('üéµ Tocando som para nova senha:', senhaAtual);
                var audio = new Audio('/static/msc/audio.mp3');
                audio.play();
                
                // Registrar para painel de chamadas concorrentes
                registrarChamadaConcorrente({
                    senha: senhaAtual,
                    operador: data.operador || 'Operador',
                    hora: new Date().toLocaleTimeString()
                });

                // Se havia uma chamada em progresso, liberar loading agora
                if (chamadaEmProgresso) {
                    finalizarChamada(true);
                }
                resolverPendente(true);
                
                // Verificar se a nova senha tem pedido
                verificarPedidoDaSenha(senhaAtual);
              } else if (novaSenha) {
                console.log('Nova senha detectada, mas n√£o √© uma senha v√°lida:', senhaAtual);
              } else {
                console.log('Mesma senha, n√£o tocando som');
              }
              
              // Atualizar a √∫ltima senha conhecida
              ultimaSenhaConhecida = senhaAtual;
            })
            .catch(error => {
              console.error('Erro ao obter a senha:', error);
            })
            .finally(() => {
              atualizandoSenha = false;
            });
        }
        
        // Fun√ß√£o para verificar se uma senha espec√≠fica tem pedido
        function verificarPedidoDaSenha(senha) {
          console.log('[VERIFICAR_PEDIDO] Verificando pedido para senha:', senha);
          fetch('/get_senhas_pendentes')
            .then(response => response.json())
            .then(senhas => {
              console.log('[VERIFICAR_PEDIDO] Senhas recebidas:', senhas);
              if (senhas && senhas.length > 0) {
                // Buscar a senha espec√≠fica que foi chamada
                const senhaChamada = senhas.find(s => s.senha === senha && s.tem_pedido && s.pedido);
                console.log('[VERIFICAR_PEDIDO] Buscando senha:', senha);
                console.log('[VERIFICAR_PEDIDO] Senha encontrada:', senhaChamada);
                
                if (senhaChamada) {
                  console.log('[VERIFICAR_PEDIDO] ‚úÖ Senha chamada tem pedido:', senhaChamada);
                  // Exibir popup com o pedido
                  showPedidoPopup(senhaChamada.senha, 'Setor Atual', senhaChamada.pedido);
                } else {
                  console.log('[VERIFICAR_PEDIDO] ‚ùå Senha chamada N√ÉO tem pedido');
                }
              } else {
                console.log('[VERIFICAR_PEDIDO] Nenhuma senha pendente encontrada');
              }
            })
            .catch(error => {
              console.error('[VERIFICAR_PEDIDO] Erro ao verificar pedido da senha:', error);
            });
        }
      
        // Atualiza a cada 10 segundos (reduzido de 5 para 10)
        setInterval(function() {
            if (!atualizandoSenha) {
                atualizarSenha();
            }
        }, 10000);
        
        // Atualizar imediatamente quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM carregado, atualizando senha...');
            atualizarSenha();
        });
        
        // Atualizar tamb√©m imediatamente (apenas uma vez)
        setTimeout(atualizarSenha, 1000);
    </script>

    <script>
        // Fun√ß√£o para setar cookies ao clicar no operador
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('#formOperador button[type="submit"]').forEach(function(btn) {
                btn.addEventListener('click', function(e) {
                    // Seta o operador_id no cookie
                    document.cookie = 'operador_id=' + encodeURIComponent(this.value) + ';path=/';
                    // O cookie da senha ser√° setado ap√≥s o backend responder (ap√≥s chamar_proxima)
                });
            });
        });
    </script>

    <script>
        // Atualiza√ß√£o em tempo real dos cards de atendimento
        socket.on('atualizar_atendimentos', function(data) {
            fetch('/get_atendimentos')
                .then(response => response.json())
                .then(atendimentos => {
                    const cardsDiv = document.getElementById('cards-atendimento-fixed');
                    cardsDiv.innerHTML = '';
                    if (atendimentos.length === 0) {
                        cardsDiv.innerHTML = '<div style="color:#888;font-size:1.1em;">Nenhum atendimento em andamento</div>';
                    } else {
                        atendimentos.forEach(function(a) {
                            const card = document.createElement('div');
                            card.className = 'card-atendimento';
                            
                            // Criar HTML para a foto do operador
                            let fotoHtml = '';
                            if (a.foto_perfil) {
                                fotoHtml = `<img src="/uploads/${a.foto_perfil}" alt="Foto de ${a.nome}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #ddd; margin-bottom: 8px;">`;
                            } else {
                                fotoHtml = `<div style="width: 40px; height: 40px; border-radius: 50%; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border: 2px solid #ddd; margin-bottom: 8px;"><span style="font-size: 20px; color: #999;">üë§</span></div>`;
                            }
                            
                            card.innerHTML = `
                                ${fotoHtml}
                                <div style="font-weight:bold;font-size:1.1em;color:#007BFF;margin-bottom:6px;">${a.nome}</div>
                                <div style="font-size:1.5em;color:#FF5733;">${a.senha}</div>
                                <div style="font-size:0.95em;color:#888;">Tipo: ${a.tipo}</div>
                                <button class="btn-chamar-novamente" onclick="chamarSenhaNovamente('${a.senha}', '${a.operador_id}')">
                                    üîî Chamar Novamente
                                </button>
                            `;
                            cardsDiv.appendChild(card);
                        });
                    }
                });
        });
        
        // Fun√ß√£o para chamar senha novamente
        function chamarSenhaNovamente(senha, operadorId) {
            enfileirarChamada({ tipo: 'repetir', senha, operadorId });
        }

        // Atualiza√ß√£o em tempo real da lista de senhas pendentes
        socket.on('atualizar_lista_senhas', function(data) {
            fetch('/get_senhas_pendentes')
                .then(response => response.json())
                .then(senhas => {
                    const tabelaBody = document.getElementById('tabela-senhas-body');
                    if (tabelaBody) {
                        tabelaBody.innerHTML = '';
                        if (senhas && senhas.length === 0) {
                            tabelaBody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#888;font-size:1.2em;">Sem senhas pendentes</td></tr>';
                        } else if (senhas) {
                            senhas.forEach(function(s) {
                                const linha = `<tr><td>${s.id}</td><td>${s.senha}</td><td>${s.tipo}</td></tr>`;
                                tabelaBody.innerHTML += linha;
                            });
                        }
                    }
                });
        });

        // Alerta de preferenciais acumuladas
        socket.on('alerta_preferenciais', function(data) {
            console.log('[SOCKET] alerta_preferenciais recebido:', data);
            var alerta = document.getElementById('alertaPreferenciais');
            var msg = document.getElementById('alertaPreferenciaisMsg');
            if (alerta && msg) {
                msg.textContent = `Aten√ß√£o: ${data.qtd} senhas preferenciais aguardando! Priorize o atendimento.`;
                alerta.style.display = 'block';
                // Esconde automaticamente ap√≥s 10 segundos
                if (alerta._timeout) clearTimeout(alerta._timeout);
                alerta._timeout = setTimeout(function() {
                    alerta.style.display = 'none';
                }, 10000);
            }
        });
        
        // Event listener para senha chamada com pedido
        socket.on('senha_chamada_com_pedido', function(data) {
            console.log('[SOCKET] senha_chamada_com_pedido recebido:', data);
            console.log('[SOCKET] Dados recebidos:', {
                senha: data.senha,
                setor: data.setor,
                pedido: data.pedido,
                setor_id: data.setor_id
            });
            
            // Verificar se o popup existe
            var popup = document.getElementById('pedidoPopup');
            if (!popup) {
                console.error('[SOCKET] Popup n√£o encontrado!');
                return;
            }
            
            console.log('[SOCKET] Popup encontrado, exibindo...');
            showPedidoPopup(data.senha, data.setor || 'N/A', data.pedido);
        });
        
        // Fun√ß√£o para verificar se h√° pedidos pendentes
        function verificarPedidosPendentes() {
            console.log('[PEDIDOS] Verificando pedidos pendentes...');
            fetch('/get_senhas_pendentes')
                .then(response => response.json())
                .then(senhas => {
                    console.log('[PEDIDOS] Resposta recebida:', senhas);
                    if (senhas && senhas.length > 0) {
                        // Verificar se alguma senha tem pedido
                        const senhaComPedido = senhas.find(s => s.tem_pedido && s.pedido);
                        if (senhaComPedido) {
                            console.log('[PEDIDOS] Senha com pedido encontrada:', senhaComPedido);
                            // Armazenar para uso posterior
                            window.senhaComPedido = senhaComPedido;
                        } else {
                            console.log('[PEDIDOS] Nenhuma senha com pedido encontrada');
                        }
                    } else {
                        console.log('[PEDIDOS] Nenhuma senha pendente encontrada');
                    }
                })
                .catch(error => {
                    console.error('[PEDIDOS] Erro ao verificar pedidos pendentes:', error);
                });
        }
        
        // Verificar pedidos pendentes quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', function() {
            verificarPedidosPendentes();
        });
        
        // Fun√ß√£o para testar notifica√ß√£o
        function testarNotificacao() {
            console.log('[TESTE] testarNotificacao chamada');
            
            if (socket) {
                console.log('[TESTE] Enviando notifica√ß√£o de teste...');
                socket.emit('pedido_confirmado', {
                    senha: 'N9999',
                    pedido: 'Pedido de teste para notifica√ß√£o',
                    mensagem: 'Pedido sendo preparado - TESTE'
                });
                console.log('[TESTE] Notifica√ß√£o de teste enviada');
                
                // Mostrar mensagem de sucesso
                alert('Notifica√ß√£o de teste enviada! Verifique a p√°gina do cliente.');
            } else {
                console.error('[TESTE] Socket n√£o encontrado!');
                alert('Erro: Socket n√£o encontrado!');
            }
        }
        
        // Fun√ß√£o para ver o pedido da senha atual
        function verPedidoAtual() {
            console.log('[VER_PEDIDO] Fun√ß√£o verPedidoAtual chamada');
            
            fetch('/get_senha_atual_setor')
                .then(response => response.json())
                .then(data => {
                    console.log('[VER_PEDIDO] Dados da senha atual:', data);
                    
                    if (data.tem_pedido && data.pedido) {
                        console.log('[VER_PEDIDO] Exibindo popup com pedido:', data.pedido);
                        showPedidoPopup(data.senha_atual, 'Setor Atual', data.pedido);
                    } else {
                        console.log('[VER_PEDIDO] Senha atual n√£o tem pedido');
                        alert('Esta senha n√£o possui pedido registrado.');
                    }
                })
                .catch(error => {
                    console.error('[VER_PEDIDO] Erro ao buscar dados da senha atual:', error);
                    alert('Erro ao buscar dados da senha atual.');
                });
        }
        
        // Fun√ß√µes para o popup do pedido
        function showPedidoPopup(senha, setor, pedido) {
            console.log('[POPUP] showPedidoPopup chamada com:', { senha, setor, pedido });
            
            var popupSenhaNumber = document.getElementById('popupSenhaNumber');
            var popupSenhaSetor = document.getElementById('popupSenhaSetor');
            var popupPedidoText = document.getElementById('popupPedidoText');
            var pedidoPopup = document.getElementById('pedidoPopup');
            
            console.log('[POPUP] Elementos encontrados:', {
                popupSenhaNumber: !!popupSenhaNumber,
                popupSenhaSetor: !!popupSenhaSetor,
                popupPedidoText: !!popupPedidoText,
                pedidoPopup: !!pedidoPopup
            });
            
            if (!popupSenhaNumber || !popupSenhaSetor || !popupPedidoText || !pedidoPopup) {
                console.error('[POPUP] Elementos do popup n√£o encontrados!');
                return;
            }
            
            console.log('[POPUP] Atualizando conte√∫do do popup...');
            popupSenhaNumber.textContent = senha;
            popupSenhaSetor.textContent = `Setor: ${setor}`;
            popupPedidoText.textContent = pedido;
            pedidoPopup.style.display = 'flex';
            
            // Atualizar t√≠tulo e bot√£o para o operador
            const popupTitle = document.querySelector('.pedido-popup-header h2');
            const confirmBtn = document.getElementById('confirmarPedido');
            
            if (popupTitle) {
                popupTitle.textContent = 'üìã Pedido do Cliente';
                console.log('[POPUP] T√≠tulo atualizado');
            }
            if (confirmBtn) {
                confirmBtn.textContent = '‚úÖ Confirmar Recebimento';
                console.log('[POPUP] Bot√£o atualizado');
            }
            
            console.log('[POPUP] ‚úÖ Popup exibido com sucesso');
            
            // Tocar som de alerta
            var audio = new Audio('/static/msc/audio.mp3');
            audio.play();
            console.log('[POPUP] Som de alerta tocado');
        }
        
        function closePedidoPopup() {
            console.log('[POPUP] closePedidoPopup chamada');
            const popup = document.getElementById('pedidoPopup');
            
            if (popup) {
                console.log('[POPUP] Popup encontrado, fechando...');
                popup.style.display = 'none';
                console.log('[POPUP] Popup fechado com sucesso');
            } else {
                console.error('[POPUP] Popup n√£o encontrado!');
            }
        }
        
        function confirmarPedido() {
            console.log('[POPUP] confirmarPedido chamada');
            console.log('[POPUP] Confirmando pedido...');
            
            // Pegar dados do popup
            const senhaElement = document.getElementById('popupSenhaNumber');
            const pedidoElement = document.getElementById('popupPedidoText');
            
            console.log('[POPUP] Elementos encontrados:', {
                senhaElement: !!senhaElement,
                pedidoElement: !!pedidoElement
            });
            
            if (!senhaElement || !pedidoElement) {
                console.error('[POPUP] Elementos do popup n√£o encontrados!');
                return;
            }
            
            const senha = senhaElement.textContent;
            const pedido = pedidoElement.textContent;
            
            console.log('[POPUP] Dados do pedido:', { senha, pedido });
            
            // Enviar notifica√ß√£o para o cliente via Socket.IO
            if (socket) {
                console.log('[POPUP] Socket encontrado, enviando notifica√ß√£o...');
                socket.emit('pedido_confirmado', {
                    senha: senha,
                    pedido: pedido,
                    mensagem: 'Pedido sendo preparado'
                });
                console.log('[POPUP] Notifica√ß√£o enviada via Socket.IO');
            } else {
                console.error('[POPUP] Socket n√£o encontrado!');
            }
            
            closePedidoPopup();
            console.log('Pedido confirmado pelo operador - iniciando atendimento');
            
            // Mostrar mensagem de confirma√ß√£o
            var alerta = document.createElement('div');
            alerta.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #28a745;
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                z-index: 9999;
                font-weight: bold;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            `;
            alerta.textContent = '‚úÖ Pedido confirmado! Iniciando atendimento...';
            document.body.appendChild(alerta);
            
            // Remover mensagem ap√≥s 3 segundos
            setTimeout(() => {
                if (alerta.parentNode) {
                    alerta.parentNode.removeChild(alerta);
                }
            }, 3000);
        }
        
        // Event listeners para o popup
        document.addEventListener('DOMContentLoaded', function() {
            console.log('[POPUP] Configurando event listeners...');
            
            const closeBtn = document.getElementById('closePedidoPopup');
            const confirmBtn = document.getElementById('confirmarPedido');
            
            console.log('[POPUP] Elementos encontrados:', {
                closeBtn: !!closeBtn,
                confirmBtn: !!confirmBtn
            });
            
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    console.log('[POPUP] Bot√£o fechar clicado');
                    closePedidoPopup();
                });
            }
            
            if (confirmBtn) {
                confirmBtn.addEventListener('click', function() {
                    console.log('[POPUP] Bot√£o confirmar clicado');
                    confirmarPedido();
                });
            }
        });
    </script>

    <!-- Cards de atendimento dos operadores fixos no rodap√© -->
    <div id="cards-atendimento-fixed">
        {% for atendimento in atendimentos %}
        <div class="card-atendimento">
            {% if atendimento[4] %}
                <img src="/uploads/{{ atendimento[4] }}" alt="Foto de {{ atendimento[1] }}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #ddd; margin-bottom: 8px;">
            {% else %}
                <div style="width: 40px; height: 40px; border-radius: 50%; background: #f0f0f0; display: flex; align-items: center; justify-content: center; border: 2px solid #ddd; margin-bottom: 8px;">
                    <span style="font-size: 20px; color: #999;">üë§</span>
                </div>
            {% endif %}
            <div style="font-weight:bold;font-size:1.1em;color:#007BFF;margin-bottom:6px;">{{ atendimento[1] }}</div>
            <div style="font-size:1.5em;color:#FF5733;">{{ atendimento[2] }}</div>
            <div style="font-size:0.95em;color:#888;">Tipo: {{ atendimento[3] }}</div>
            <button class="btn-chamar-novamente" onclick="chamarSenhaNovamente('{{ atendimento[2] }}', '{{ atendimento[0] }}')">
                üîî Chamar Novamente
            </button>
        </div>
        {% endfor %}
    </div>

    <!-- Alerta de preferenciais acumuladas -->
    <div id="alertaPreferenciais" class="alerta-preferenciais" style="display:none;">
        <span id="alertaPreferenciaisMsg"></span>
        <button class="close-alerta" onclick="document.getElementById('alertaPreferenciais').style.display='none'">&times;</button>
    </div>

    <!-- Popup do Pedido -->
    <div id="pedidoPopup" class="pedido-popup" style="display: none;">
        <div class="pedido-popup-content">
            <div class="pedido-popup-header">
                <h2>üìã Pedido do Cliente</h2>
                <button id="closePedidoPopup" class="close-btn">&times;</button>
            </div>
            <div class="pedido-popup-body">
                <div class="senha-info-popup">
                    <div class="senha-number-popup" id="popupSenhaNumber">N/A</div>
                    <div class="senha-setor-popup" id="popupSenhaSetor">Setor: N/A</div>
                </div>
                <div class="pedido-content">
                    <h3>üìù Pedido:</h3>
                    <div class="pedido-text" id="popupPedidoText">Carregando...</div>
                </div>
            </div>
            <div class="pedido-popup-footer">
                <button id="confirmarPedido" class="btn confirm-btn">
                    ‚úÖ Confirmar Recebimento
                </button>
            </div>
        </div>
    </div>

</body>
</html>
