<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Avalia√ß√£o de Atendimento</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* Desabilitar zoom e sele√ß√£o de texto */
        body {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Permitir sele√ß√£o apenas em campos de input */
        input, textarea, select {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        
        .stars {
            display: flex;
            flex-direction: row-reverse;
            justify-content: center;
        }
        .stars input[type="radio"] {
            display: none;
        }
        .stars label {
            font-size: 2.5em;
            color: #ccc;
            cursor: pointer;
            transition: color 0.2s;
        }
        .stars input[type="radio"]:checked ~ label,
        .stars label:hover,
        .stars label:hover ~ label {
            color: #FFD700;
        }
        
        /* Estilos para o card do operador */
        .operador-card {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin: 20px auto 30px auto;
            padding: 20px;
            background: linear-gradient(135deg, rgba(0, 123, 255, 0.1) 0%, rgba(0, 86, 179, 0.1) 100%);
            border-radius: 15px;
            border: 2px solid rgba(0, 123, 255, 0.3);
            max-width: 400px;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.1);
        }
        
        .operador-foto {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid rgba(0, 123, 255, 0.4);
            background: rgba(0, 123, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .operador-foto img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .avatar-placeholder {
            font-size: 35px;
            color: rgba(0, 123, 255, 0.6);
        }
        
        .operador-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
            text-align: left;
        }
        
        .operador-nome {
            font-size: 1.3rem;
            font-weight: bold;
            color: #007BFF;
        }
        
        .operador-status {
            font-size: 0.9rem;
            color: #666;
            background: rgba(0, 123, 255, 0.1);
            padding: 4px 12px;
            border-radius: 12px;
            display: inline-block;
            width: fit-content;
        }
        
        /* Responsividade */
        @media (max-width: 768px) {
            .operador-card {
                flex-direction: column;
                text-align: center;
                gap: 15px;
                margin: 15px auto 25px auto;
            }
            
            .operador-info {
                text-align: center;
            }
            
            .operador-nome {
                font-size: 1.2rem;
            }
            
            .operador-foto {
                width: 60px;
                height: 60px;
            }
            
            .avatar-placeholder {
                font-size: 30px;
            }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.4.1/socket.io.js"></script>
    <script>
        // Detectar se est√° em WebView
        function isWebView() {
            return /WebView|wv|AndroidWebView|FBAV|FBAN|Instagram|Line|Twitter|LinkedInApp|WhatsApp|Telegram/i.test(navigator.userAgent);
        }
        
        // Configura√ß√µes espec√≠ficas para WebView
        if (isWebView()) {
            console.log('[WEBVIEW] Detectado WebView - aplicando configura√ß√µes espec√≠ficas');
            
            // For√ßar atualiza√ß√£o da p√°gina a cada 5 segundos em WebView
            setInterval(function() {
                console.log('[WEBVIEW] For√ßando atualiza√ß√£o da p√°gina...');
                // For√ßar recarregamento sem cache
                window.location.reload(true);
            }, 5000);
            
            // Prevenir cache do navegador
            window.addEventListener('pageshow', function(event) {
                if (event.persisted) {
                    window.location.reload();
                }
            });
            
            // For√ßar recarregamento ao focar na janela
            window.addEventListener('focus', function() {
                console.log('[WEBVIEW] Janela focada, verificando atualiza√ß√µes...');
                setTimeout(function() {
                    window.location.reload(true);
                }, 1000);
            });
        }
        
        // Inst√¢ncia global do socket para evitar duplicidade
        window._socket = window._socket || io();
        window._socket.on('connect', function() {
            console.log('[SOCKETIO] Conectado ao servidor Socket.IO!');
        });
        
        // Fallback para WebView - tentar reconectar socket se desconectar
        window._socket.on('disconnect', function() {
            console.log('[SOCKETIO] Desconectado do servidor!');
            if (isWebView()) {
                console.log('[WEBVIEW] Tentando reconectar socket...');
                setTimeout(function() {
                    window._socket.connect();
                }, 1000);
            }
        });
        
        // Fun√ß√£o para detectar 3 cliques consecutivos
        (function() {
            let clickCount = 0;
            let clickTimer = null;
            const CLICK_TIMEOUT = 1000; // 1 segundo para cliques consecutivos
            const REQUIRED_CLICKS = 3; // 3 cliques para recarregar
            
            function handleConsecutiveClicks() {
                clickCount++;
                console.log(`[CLIQUES] Clique ${clickCount} de ${REQUIRED_CLICKS}`);
                
                if (clickTimer) {
                    clearTimeout(clickTimer);
                }
                
                if (clickCount >= REQUIRED_CLICKS) {
                    console.log('[CLIQUES] 3 cliques consecutivos detectados! Recarregando p√°gina...');
                    window.location.reload();
                    return;
                }
                
                clickTimer = setTimeout(function() {
                    console.log('[CLIQUES] Timeout atingido, resetando contador');
                    clickCount = 0;
                }, CLICK_TIMEOUT);
            }
            
            // Adicionar listener de clique ao documento
            document.addEventListener('click', function(event) {
                // Ignorar cliques em elementos interativos
                const tagName = event.target.tagName;
                const isInteractive = tagName === 'A' || tagName === 'BUTTON' || 
                                    tagName === 'INPUT' || tagName === 'SELECT' || 
                                    tagName === 'TEXTAREA';
                
                // Ignorar cliques dentro de formul√°rios ou elementos interativos
                const isInForm = event.target.closest('form') || 
                                event.target.closest('a') || 
                                event.target.closest('button') || 
                                event.target.closest('input') || 
                                event.target.closest('select') || 
                                event.target.closest('textarea');
                
                if (!isInteractive && !isInForm) {
                    handleConsecutiveClicks();
                }
            });
            
                    console.log('[CLIQUES] Sistema de 3 cliques consecutivos ativado');
    })();
    
    // Prevenir zoom via gestos e duplo clique
    document.addEventListener('gesturestart', function(e) {
        e.preventDefault();
    });
    
    document.addEventListener('gesturechange', function(e) {
        e.preventDefault();
    });
    
    document.addEventListener('gestureend', function(e) {
        e.preventDefault();
    });
    
    // Prevenir zoom via duplo clique
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function(event) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
            event.preventDefault();
        }
        lastTouchEnd = now;
    }, false);
    
    // Prevenir zoom via Ctrl+scroll
    document.addEventListener('wheel', function(e) {
        if (e.ctrlKey) {
            e.preventDefault();
        }
    }, { passive: false });
    
    // Prevenir zoom via Ctrl+plus/minus
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && (e.key === '+' || e.key === '-' || e.key === '=')) {
            e.preventDefault();
        }
    });
</script>
</head>
<body>
    <div class="container">
        {% if saudacao %}
            <h1>Obrigado pela avalia√ß√£o!</h1>
            <h2>Aguardando chamada de pr√≥xima senha...</h2>
        {% elif senha_id and setor_id and operador_id %}
            <h1>Avalie o Atendimento</h1>
            
            <!-- Card do operador com foto -->
            {% if operador_nome %}
            <div class="operador-card">
                <div class="operador-foto">
                    {% if operador_foto %}
                        <img src="/uploads/{{ operador_foto }}" alt="Foto de {{ operador_nome }}">
                    {% else %}
                        <div class="avatar-placeholder">üë§</div>
                    {% endif %}
                </div>
                <div class="operador-info">
                    <div class="operador-nome">{{ operador_nome }}</div>
                    <div class="operador-status">Aguardando sua avalia√ß√£o</div>
                </div>
            </div>
            {% endif %}
            
            {% if senha_texto %}
                <div style="font-size:2.1em;color:#007BFF;margin-bottom:10px;">Senha: <b>{{ senha_texto }}</b></div>
            {% endif %}
            <div id="timerBarContainer" style="width:100%;max-width:400px;margin:0 auto 18px auto;height:18px;background:#eee;border-radius:8px;overflow:hidden;">
                <div id="timerBar" style="height:100%;width:100%;background:linear-gradient(90deg,#43e97b,#38f9d7);transition:width 0.2s;"></div>
            </div>
            <form method="POST" id="formAvaliacao">
                <div class="stars">
                    <input type="radio" id="star5" name="nota" value="5"><label for="star5">‚òÖ</label>
                    <input type="radio" id="star4" name="nota" value="4"><label for="star4">‚òÖ</label>
                    <input type="radio" id="star3" name="nota" value="3"><label for="star3">‚òÖ</label>
                    <input type="radio" id="star2" name="nota" value="2"><label for="star2">‚òÖ</label>
                    <input type="radio" id="star1" name="nota" value="1" required><label for="star1">‚òÖ</label>
                </div>
                <button type="submit" style="margin-top:20px;">Enviar Avalia√ß√£o</button>
            </form>
            <script>
                // Timeout para avalia√ß√£o autom√°tica ap√≥s 8 segundos
                var autoAvaliaTimeout = setTimeout(function() {
                    if (!document.querySelector('input[name="nota"]:checked')) {
                        var form = document.createElement('form');
                        form.method = 'POST';
                        form.action = '';
                        var input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = 'nota';
                        input.value = '';
                        form.appendChild(input);
                        document.body.appendChild(form);
                        form.submit();
                    }
                }, 8000);
                // Barra de tempo visual
                var timerBar = document.getElementById('timerBar');
                var timerBarContainer = document.getElementById('timerBarContainer');
                var timerStart = Date.now();
                var timerDuration = 8000;
                function updateTimerBar() {
                    var elapsed = Date.now() - timerStart;
                    var percent = Math.max(0, 100 - (elapsed / timerDuration) * 100);
                    if (timerBar) timerBar.style.width = percent + '%';
                    if (percent > 0) {
                        requestAnimationFrame(updateTimerBar);
                    }
                }
                if (timerBar) updateTimerBar();
                // Se chegar nova senha para avalia√ß√£o, cancela o timeout e esconde a barra
                window._socket.on('nova_senha_para_avaliacao', function(data) {
                    // S√≥ redireciona se o operador_id do evento for igual ao do cookie
                    function getCookie(name) {
                        let match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
                        if (match) return match[2];
                    }
                    var operadorIdCookie = getCookie('operador_id');
                    if (String(data.operador_id) === String(operadorIdCookie)) {
                        if (autoAvaliaTimeout) clearTimeout(autoAvaliaTimeout);
                        if (timerBarContainer) timerBarContainer.style.display = 'none';
                        window.location.href = `/avaliacao?senha_id=${data.senha_id}&setor_id=${data.setor_id}&operador_id=${data.operador_id}`;
                    }
                });
                // Se o usu√°rio clicar em uma estrela ou enviar, esconde a barra
                document.querySelectorAll('input[name="nota"]').forEach(function(radio) {
                    radio.addEventListener('change', function() {
                        if (timerBarContainer) timerBarContainer.style.display = 'none';
                        if (autoAvaliaTimeout) clearTimeout(autoAvaliaTimeout);
                    });
                });
                document.getElementById('formAvaliacao').addEventListener('submit', function(e) {
                    var nota = document.querySelector('input[name="nota"]:checked');
                    if (nota) {
                        var valor = parseInt(nota.value);
                        var audio = null;
                        if (valor >= 3) {
                            audio = new Audio('/static/msc/nota_ruim.mp3');
                        } else if (valor > 0) {
                            audio = new Audio('/static/msc/nota_boa.mp3');
                        }
                        if (audio) {
                            e.preventDefault();
                            audio.play();
                            audio.onended = function() { e.target.submit(); };
                        }
                    }
                    if (timerBarContainer) timerBarContainer.style.display = 'none';
                    if (autoAvaliaTimeout) clearTimeout(autoAvaliaTimeout);
                });
            </script>
        {% else %}
            <h1>Aguardando chamada de pr√≥xima senha...</h1>
        {% endif %}
    </div>
    {% if auto_finalize %}
    <script>
        setTimeout(function() {
            // Se o usu√°rio n√£o enviou, envia nota vazia automaticamente
            if (!document.querySelector('input[name="nota"]:checked')) {
                var form = document.createElement('form');
                form.method = 'POST';
                form.action = '';
                var input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'nota';
                input.value = '';
                form.appendChild(input);
                document.body.appendChild(form);
                form.submit();
            }
        }, 5000);
    </script>
    {% endif %}
            {% if saudacao %}
    <script>
        // Atualiza a tela em tempo real quando o operador chamar a pr√≥xima senha
        function getCookie(name) {
            let match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
            if (match) return match[2];
        }
        const operadorIdCookie = getCookie('operador_id');
        
        // Fun√ß√£o para verificar se h√° nova senha via polling (fallback para WebView)
        function checkForNewSenha() {
            if (isWebView()) {
                fetch('/check_webview_update')
                    .then(response => response.json())
                    .then(data => {
                        console.log('[WEBVIEW] Verifica√ß√£o de atualiza√ß√£o:', data);
                        
                        if (data.force_reload) {
                            console.log('[WEBVIEW] For√ßando recarregamento devido a avalia√ß√£o pendente');
                            window.location.reload(true);
                            return;
                        }
                        
                        if (data.senha_atual && data.senha_atual !== '{{ senha_atual if senha_atual else "" }}') {
                            console.log('[WEBVIEW] Nova senha detectada via polling, recarregando...');
                            window.location.reload(true);
                        }
                    })
                    .catch(error => {
                        console.log('[WEBVIEW] Erro no polling:', error);
                    });
            }
        }
        
        // Socket.IO para navegadores normais
        window._socket.on('nova_senha_operador', function(data) {
            if (data.operador_id == operadorIdCookie) {
                window.location.reload();
            }
        });
        
        // Polling para WebView a cada 3 segundos
        if (isWebView()) {
            setInterval(checkForNewSenha, 3000);
        }
    </script>
    {% endif %}
    {% if saudacao %}
    <script>
        function getCookie(name) {
            let match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
            if (match) return match[2];
        }
        window._socket.on('nova_senha_para_avaliacao', function(data) {
            console.log('[SOCKETIO] Evento recebido', data);
            // Redireciona para a tela de avalia√ß√£o da senha correta
            window.location.href = `/avaliacao?senha_id=${data.senha_id}&setor_id=${data.setor_id}&operador_id=${data.operador_id}`;
        });
    </script>
    {% endif %}
</body>
</html> 