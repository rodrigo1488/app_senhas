<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Senha Atual</title>
    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <meta name="theme-color" content="#ffffff">
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 50%, #0c0c0c 100%);
            color: #fff;
            overflow: hidden;
            position: relative;
        }
        
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(0, 230, 118, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0, 188, 212, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }
        
        #container {
            text-align: center;
            padding: 40px;
            border-radius: 25px;
            background: rgba(18, 18, 18, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 230, 118, 0.2);
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.5),
                0 0 0 1px rgba(0, 230, 118, 0.1);
            position: relative;
            z-index: 1;
            min-width: 400px;
            max-width: 600px;
        }
        h1 {
            font-size: 3.5rem;
            margin-bottom: 30px;
            color: #00e676;
            text-shadow: 0 0 20px rgba(0, 230, 118, 0.5);
            font-weight: 300;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        
        #senha_atual {
            font-size: 8rem;
            font-weight: bold;
            animation: fadeIn 0.5s ease-in-out;
            color: #fff;
            text-shadow: 
                0 0 30px rgba(0, 230, 118, 0.8),
                0 0 60px rgba(0, 230, 118, 0.4);
            margin: 30px 0;
            font-family: 'Courier New', monospace;
            letter-spacing: 5px;
            line-height: 1.2;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            text-align: center;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        /* Estilo espec√≠fico para mensagem de aguardando */
        #senha_atual.aguardando {
            font-size: 3.5rem;
            line-height: 1.3;
            min-height: 100px;
            padding: 20px;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Estilos para o card do operador */
        .operador-card {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(0, 230, 118, 0.1) 0%, rgba(0, 188, 212, 0.1) 100%);
            border-radius: 20px;
            border: 2px solid rgba(0, 230, 118, 0.3);
            backdrop-filter: blur(10px);
            animation: slideInUp 0.6s ease-out;
        }
        
        .operador-foto {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid rgba(0, 230, 118, 0.5);
            background: rgba(0, 230, 118, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 20px rgba(0, 230, 118, 0.3);
        }
        
        .operador-foto img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .avatar-placeholder {
            font-size: 40px;
            color: rgba(0, 230, 118, 0.7);
        }
        
        .operador-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
            text-align: left;
        }
        
        .operador-nome {
            font-size: 1.8rem;
            font-weight: bold;
            color: #00e676;
            text-shadow: 0 0 10px rgba(0, 230, 118, 0.5);
        }
        
        .operador-status {
            font-size: 1rem;
            color: #00bcd4;
            background: rgba(0, 188, 212, 0.2);
            padding: 5px 15px;
            border-radius: 15px;
            display: inline-block;
            width: fit-content;
            border: 1px solid rgba(0, 188, 212, 0.3);
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Responsividade */
        @media (max-width: 768px) {
            #container {
                min-width: 90vw;
                max-width: 95vw;
                padding: 30px 20px;
            }
            
            h1 {
                font-size: 2.5rem;
            }
            
            #senha_atual {
                font-size: 5rem;
                letter-spacing: 3px;
                min-height: 80px;
                line-height: 1.1;
            }
            
            #senha_atual.aguardando {
                font-size: 2.5rem;
                min-height: 70px;
                padding: 15px;
            }
            
            .operador-card {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .operador-info {
                text-align: center;
            }
            
            .operador-nome {
                font-size: 1.5rem;
            }
            
            .operador-foto {
                width: 60px;
                height: 60px;
            }
            
            .avatar-placeholder {
                font-size: 30px;
            }
        }
        
        @media (max-width: 480px) {
            h1 {
                font-size: 2rem;
            }
            
            #senha_atual {
                font-size: 4rem;
                letter-spacing: 2px;
                min-height: 60px;
                line-height: 1.0;
            }
            
            #senha_atual.aguardando {
                font-size: 2rem;
                min-height: 50px;
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="container">
        <h1>Senha Atual</h1>
        <div id="senha_atual">Carregando...</div>
        
        <!-- Card do operador com foto -->
        <div id="operador_card" class="operador-card" style="display: none;">
            <div class="operador-foto" id="operador_foto">
                <div class="avatar-placeholder">üë§</div>
            </div>
            <div class="operador-info">
                <div class="operador-nome" id="operador_nome">Operador</div>
                <div class="operador-status">Atendendo agora</div>
            </div>
        </div>
    </div>
    <script>
        // Vari√°vel para armazenar a √∫ltima senha conhecida
        let ultimaSenhaConhecida = null;
        
        // Vari√°vel para controlar se o √°udio foi desbloqueado (necess√°rio para autoplay)
        let audioDesbloqueado = false;
        
        // Fun√ß√£o para desbloquear o √°udio (chamada na primeira intera√ß√£o do usu√°rio)
        function desbloquearAudio() {
            if (!audioDesbloqueado) {
                // Criar um √°udio silencioso e tocar para desbloquear autoplay
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OSdTgwOUKzn8LZjGwU7kdfyznksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBtpvfDknU4MDlCs5/C2YxsFO5HX8s55LAUkd8fw3ZBAC');
                audio.volume = 0.01;
                audio.play().then(() => {
                    audioDesbloqueado = true;
                    console.log('‚úÖ √Åudio desbloqueado para autoplay');
                }).catch(err => {
                    console.warn('‚ö†Ô∏è N√£o foi poss√≠vel desbloquear √°udio:', err);
                });
            }
        }
        
        // Desbloquear √°udio na primeira intera√ß√£o do usu√°rio
        document.addEventListener('click', desbloquearAudio, { once: true });
        document.addEventListener('touchstart', desbloquearAudio, { once: true });
        document.addEventListener('keydown', desbloquearAudio, { once: true });
        
        // Fun√ß√£o para tocar o som da senha
        function tocarSomSenha() {
            try {
                // Usar o caminho correto do Flask
                const audioPath = '{{ url_for("static", filename="msc/audio.mp3") }}';
                console.log('üéµ Tentando tocar som do caminho:', audioPath);
                
                const audio = new Audio(audioPath);
                
                // Configurar volume
                audio.volume = 1.0;
                
                // Eventos para debug
                audio.addEventListener('loadstart', () => {
                    console.log('üîÑ √Åudio iniciando carregamento...');
                });
                
                audio.addEventListener('canplay', () => {
                    console.log('‚úÖ √Åudio pronto para tocar');
                });
                
                audio.addEventListener('play', () => {
                    console.log('‚ñ∂Ô∏è √Åudio come√ßou a tocar');
                });
                
                audio.addEventListener('ended', () => {
                    console.log('‚èπÔ∏è √Åudio terminou');
                });
                
                audio.addEventListener('error', (e) => {
                    console.error('‚ùå Erro ao tocar √°udio:', e);
                    console.error('   Tipo de erro:', audio.error);
                    console.error('   C√≥digo:', audio.error ? audio.error.code : 'N/A');
                    console.error('   Mensagem:', audio.error ? audio.error.message : 'N/A');
                    
                    // Tentar caminho alternativo
                    console.log('üîÑ Tentando caminho alternativo...');
                    const audioAlt = new Audio('/static/msc/audio.mp3');
                    audioAlt.volume = 1.0;
                    audioAlt.play().catch(err => {
                        console.error('‚ùå Erro tamb√©m no caminho alternativo:', err);
                    });
                });
                
                // Tentar tocar o √°udio
                const playPromise = audio.play();
                
                if (playPromise !== undefined) {
                    playPromise
                        .then(() => {
                            console.log('‚úÖ Som tocado com sucesso');
                        })
                        .catch(error => {
                            console.error('‚ùå Erro ao tocar som (autoplay bloqueado?):', error);
                            console.log('üí° Dica: Alguns navegadores bloqueiam autoplay. Tente clicar na p√°gina primeiro.');
                            
                            // Tentar novamente ap√≥s um pequeno delay
                            setTimeout(() => {
                                audio.play().catch(err => {
                                    console.error('‚ùå Erro na segunda tentativa:', err);
                                });
                            }, 100);
                        });
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao criar objeto Audio:', error);
            }
        }
        
        // Fun√ß√£o para ler a senha em voz alta
        function lerSenha(senha) {
            // Verificar se a Web Speech API est√° dispon√≠vel
            if ('speechSynthesis' in window) {
                // Cancelar qualquer leitura anterior
                window.speechSynthesis.cancel();
                
                // Criar o texto a ser lido
                // Formatar a senha para leitura (ex: "N1234" -> "Senha N um dois tr√™s quatro")
                let textoParaLer = 'Senha ';
                
                // Separar letra e n√∫meros
                const letra = senha.charAt(0);
                const numeros = senha.substring(1);
                
                // Adicionar a letra
                textoParaLer += letra + ' ';
                
                // Adicionar cada n√∫mero por extenso
                const numerosPorExtenso = {
                    '0': 'zero',
                    '1': 'um',
                    '2': 'dois',
                    '3': 'tr√™s',
                    '4': 'quatro',
                    '5': 'cinco',
                    '6': 'seis',
                    '7': 'sete',
                    '8': 'oito',
                    '9': 'nove'
                };
                
                for (let i = 0; i < numeros.length; i++) {
                    const digito = numeros[i];
                    if (numerosPorExtenso[digito]) {
                        textoParaLer += numerosPorExtenso[digito] + ' ';
                    }
                }
                
                // Criar a utterance
                const utterance = new SpeechSynthesisUtterance(textoParaLer);
                
                // Configurar a voz em portugu√™s
                utterance.lang = 'pt-BR';
                utterance.rate = 0.75; // Velocidade mais fluida (0.1 a 10) - balanceada entre clareza e fluidez
                utterance.pitch = 1.15; // Tom mais alto para voz feminina mais natural (0 a 2)
                utterance.volume = 1.0; // Volume (0 a 1)
                
                // Obter todas as vozes dispon√≠veis
                const voices = window.speechSynthesis.getVoices();
                
                // Listar todas as vozes dispon√≠veis no console (para debug)
                console.log('üé§ Vozes dispon√≠veis no sistema:', voices.length);
                voices.forEach((voice, index) => {
                    if (voice.lang.includes('pt') || voice.lang.includes('PT')) {
                        console.log(`   ${index + 1}. ${voice.name} (${voice.lang}) - ${voice.gender || 'g√™nero n√£o especificado'}`);
                    }
                });
                
                // Priorizar vozes femininas mais fluidas e modernas
                // Vozes premium/neural geralmente t√™m nomes espec√≠ficos
                let portugueseVoice = null;
                
                // Lista de nomes de vozes femininas conhecidas e fluidas (em ordem de prefer√™ncia)
                const vozesFemininasPreferidas = [
                    // Vozes Windows (mais fluidas)
                    'maria', 'helena', 'heloisa', 'lucia', 'vit√≥ria', 'isabela', 'ana',
                    // Vozes Google/Chrome (neural, muito fluidas)
                    'google portugu√™s do brasil', 'pt-br', 'brazil',
                    // Vozes macOS (Siri-like, muito fluidas)
                    'lucia', 'maria', 'helena',
                    // Vozes gen√©ricas
                    'female', 'mulher', 'feminina', 'woman'
                ];
                
                // Fun√ß√£o para verificar se uma voz √© feminina
                function isFemaleVoice(voice) {
                    const nameLower = voice.name.toLowerCase();
                    return vozesFemininasPreferidas.some(pref => nameLower.includes(pref)) ||
                           (voice.gender && voice.gender === 'female') ||
                           nameLower.includes('female') ||
                           nameLower.includes('mulher') ||
                           nameLower.includes('feminina');
                }
                
                // Fun√ß√£o para verificar qualidade da voz (vozes neural/premium s√£o melhores)
                function isHighQualityVoice(voice) {
                    const nameLower = voice.name.toLowerCase();
                    return nameLower.includes('neural') ||
                           nameLower.includes('premium') ||
                           nameLower.includes('enhanced') ||
                           nameLower.includes('google') ||
                           nameLower.includes('siri') ||
                           nameLower.includes('cortana');
                }
                
                // Estrat√©gia 1: Voz feminina em portugu√™s de alta qualidade (neural/premium)
                portugueseVoice = voices.find(voice => {
                    const isPortuguese = voice.lang.includes('pt') || voice.lang.includes('PT');
                    return isPortuguese && isFemaleVoice(voice) && isHighQualityVoice(voice);
                });
                
                // Estrat√©gia 2: Voz feminina em portugu√™s (qualquer qualidade)
                if (!portugueseVoice) {
                    portugueseVoice = voices.find(voice => {
                        const isPortuguese = voice.lang.includes('pt') || voice.lang.includes('PT');
                        return isPortuguese && isFemaleVoice(voice);
                    });
                }
                
                // Estrat√©gia 3: Voz em portugu√™s (qualquer g√™nero, mas preferir nomes femininos)
                if (!portugueseVoice) {
                    // Tentar vozes com nomes femininos primeiro
                    portugueseVoice = voices.find(voice => {
                        const isPortuguese = voice.lang.includes('pt') || voice.lang.includes('PT');
                        const nameLower = voice.name.toLowerCase();
                        return isPortuguese && (
                            nameLower.includes('maria') ||
                            nameLower.includes('helena') ||
                            nameLower.includes('heloisa') ||
                            nameLower.includes('lucia') ||
                            nameLower.includes('vit√≥ria') ||
                            nameLower.includes('isabela')
                        );
                    });
                }
                
                // Estrat√©gia 4: Qualquer voz em portugu√™s
                if (!portugueseVoice) {
                    portugueseVoice = voices.find(voice => 
                        voice.lang.includes('pt') || voice.lang.includes('PT')
                    );
                }
                
                // Estrat√©gia 5: Voz feminina de alta qualidade (qualquer idioma)
                if (!portugueseVoice) {
                    portugueseVoice = voices.find(voice => 
                        isFemaleVoice(voice) && isHighQualityVoice(voice)
                    );
                }
                
                // Estrat√©gia 6: Qualquer voz feminina dispon√≠vel
                if (!portugueseVoice) {
                    portugueseVoice = voices.find(voice => isFemaleVoice(voice));
                }
                
                if (portugueseVoice) {
                    utterance.voice = portugueseVoice;
                    console.log('‚úÖ Voz selecionada:', portugueseVoice.name);
                    console.log('   Idioma:', portugueseVoice.lang);
                    console.log('   G√™nero:', portugueseVoice.gender || 'n√£o especificado');
                    console.log('   Qualidade:', isHighQualityVoice(portugueseVoice) ? 'Alta (Neural/Premium)' : 'Padr√£o');
                } else {
                    console.log('‚ö†Ô∏è Nenhuma voz feminina encontrada, usando voz padr√£o do sistema');
                    // Ajustar pitch para tentar simular voz feminina
                    utterance.pitch = 1.3;
                    utterance.rate = 0.6; // Ainda mais lenta se n√£o tiver voz espec√≠fica
                }
                
                // Eventos para debug
                utterance.onstart = function() {
                    console.log('üîä Iniciando leitura da senha:', senha);
                };
                
                utterance.onend = function() {
                    console.log('‚úÖ Leitura da senha conclu√≠da');
                };
                
                utterance.onerror = function(event) {
                    console.error('‚ùå Erro na leitura:', event.error);
                };
                
                // Reproduzir a voz
                window.speechSynthesis.speak(utterance);
                
            } else {
                console.warn('‚ö†Ô∏è Web Speech API n√£o est√° dispon√≠vel neste navegador');
            }
        }
        
        // Fun√ß√£o para listar todas as vozes dispon√≠veis (√∫til para debug)
        function listarVozesDisponiveis() {
            if ('speechSynthesis' in window) {
                const voices = window.speechSynthesis.getVoices();
                console.log('üìã TODAS AS VOZES DISPON√çVEIS NO SISTEMA:');
                console.log('='.repeat(60));
                
                const vozesPortugues = voices.filter(v => v.lang.includes('pt') || v.lang.includes('PT'));
                const vozesFemininas = voices.filter(v => {
                    const name = v.name.toLowerCase();
                    return name.includes('female') || name.includes('mulher') || 
                           name.includes('feminina') || name.includes('maria') ||
                           name.includes('helena') || name.includes('heloisa') ||
                           name.includes('lucia') || name.includes('vit√≥ria') ||
                           (v.gender && v.gender === 'female');
                });
                
                console.log(`\nüáßüá∑ VOZES EM PORTUGU√äS (${vozesPortugues.length}):`);
                vozesPortugues.forEach((voice, i) => {
                    const isFemale = vozesFemininas.includes(voice);
                    const quality = voice.name.toLowerCase().includes('neural') || 
                                  voice.name.toLowerCase().includes('premium') ? '‚≠ê PREMIUM' : '   Padr√£o';
                    console.log(`   ${i + 1}. ${voice.name.padEnd(30)} ${voice.lang.padEnd(10)} ${isFemale ? 'üë©' : 'üë§'} ${quality}`);
                });
                
                console.log(`\nüë© VOZES FEMININAS (${vozesFemininas.length}):`);
                vozesFemininas.forEach((voice, i) => {
                    const isPortuguese = voice.lang.includes('pt') || voice.lang.includes('PT');
                    const quality = voice.name.toLowerCase().includes('neural') || 
                                  voice.name.toLowerCase().includes('premium') ? '‚≠ê PREMIUM' : '   Padr√£o';
                    console.log(`   ${i + 1}. ${voice.name.padEnd(30)} ${voice.lang.padEnd(10)} ${isPortuguese ? 'üáßüá∑' : 'üåê'} ${quality}`);
                });
                
                console.log('='.repeat(60));
            }
        }
        
        // Carregar vozes quando dispon√≠veis (alguns navegadores carregam assincronamente)
        if ('speechSynthesis' in window) {
            // Tentar carregar vozes imediatamente
            let voices = window.speechSynthesis.getVoices();
            if (voices.length === 0) {
                // Se n√£o houver vozes, aguardar o evento 'voiceschanged'
                window.speechSynthesis.onvoiceschanged = function() {
                    voices = window.speechSynthesis.getVoices();
                    console.log('üé§ Vozes carregadas:', voices.length);
                    // Listar vozes dispon√≠veis ap√≥s carregar
                    setTimeout(listarVozesDisponiveis, 500);
                };
            } else {
                console.log('üé§ Vozes dispon√≠veis:', voices.length);
                // Listar vozes dispon√≠veis
                setTimeout(listarVozesDisponiveis, 500);
            }
        }
        
        // Expor fun√ß√£o global para testar vozes (√∫til para debug)
        window.testarVoz = function(nomeVoz) {
            if ('speechSynthesis' in window) {
                const voices = window.speechSynthesis.getVoices();
                const voice = voices.find(v => v.name.toLowerCase().includes(nomeVoz.toLowerCase()));
                
                if (voice) {
                    const utterance = new SpeechSynthesisUtterance('Senha N um dois tr√™s quatro');
                    utterance.voice = voice;
                    utterance.lang = 'pt-BR';
                    utterance.rate = 0.75;
                    utterance.pitch = 1.15;
                    window.speechSynthesis.speak(utterance);
                    console.log('‚úÖ Testando voz:', voice.name);
                } else {
                    console.log('‚ùå Voz n√£o encontrada. Use listarVozesDisponiveis() para ver todas as vozes.');
                }
            }
        };
        
        // Expor fun√ß√£o para listar vozes globalmente
        window.listarVozesDisponiveis = listarVozesDisponiveis;
        
        function atualizarSenhaAtual() {
            if (atualizandoSenhaAtual) {
                console.log('J√° est√° atualizando senha atual, ignorando...');
                return;
            }
            
            atualizandoSenhaAtual = true;
            console.log('Atualizando senha atual...');
            
            fetch('/get_senha_atual_setor')
                .then(response => response.json())
                .then(data => {
                    console.log('Dados recebidos:', data);
                    var senhaElement = document.getElementById('senha_atual');
                    
                    // Verificar se √© uma nova senha
                    const senhaAtual = data.senha_atual || 'Nenhuma';
                    // Nova senha = mudou de uma senha para outra (n√£o √© a primeira vez e √© diferente)
                    // OU √© a primeira vez que temos uma senha v√°lida
                    const primeiraSenhaValida = ultimaSenhaConhecida === null && 
                                                 senhaAtual !== 'Nenhuma' && 
                                                 senhaAtual !== 'Aguardando pr√≥xima senha...' && 
                                                 senhaAtual !== 'Setor n√£o selecionado.';
                    const novaSenha = (ultimaSenhaConhecida !== null && ultimaSenhaConhecida !== senhaAtual) || primeiraSenhaValida;
                    
                    // Debug detalhado
                    console.log('üìä Debug de nova senha:');
                    console.log('   Senha atual recebida:', senhaAtual);
                    console.log('   √öltima senha conhecida:', ultimaSenhaConhecida);
                    console.log('   √â primeira senha v√°lida?', primeiraSenhaValida);
                    console.log('   √â nova senha?', novaSenha);
                    console.log('   Condi√ß√£o completa:', novaSenha && senhaAtual !== 'Nenhuma' && senhaAtual !== 'Aguardando pr√≥xima senha...' && senhaAtual !== 'Setor n√£o selecionado.');
                    
                    if (senhaElement) {
                        senhaElement.innerText = senhaAtual;
                        
                        // Aplicar classe espec√≠fica para mensagem de aguardando
                        if (senhaAtual === 'Aguardando pr√≥xima senha...') {
                            senhaElement.classList.add('aguardando');
                        } else {
                            senhaElement.classList.remove('aguardando');
                        }
                        
                        console.log('Senha atualizada:', senhaAtual);
                    } else {
                        console.error('Elemento senha_atual n√£o encontrado');
                    }
                    
                    // Atualizar card do operador
                    var operadorCard = document.getElementById('operador_card');
                    var operadorNome = document.getElementById('operador_nome');
                    var operadorFoto = document.getElementById('operador_foto');
                    
                    console.log('Elementos encontrados:', {
                        operadorCard: !!operadorCard,
                        operadorNome: !!operadorNome,
                        operadorFoto: !!operadorFoto
                    });
                    
                    if (data.operador && data.operador !== '') {
                        console.log('Operador encontrado:', data.operador);
                        if (operadorNome) operadorNome.innerText = data.operador;
                        if (operadorCard) {
                            operadorCard.style.display = 'flex';
                            console.log('Card do operador exibido');
                        }
                        
                        // Atualizar foto do operador
                        if (operadorFoto) {
                            if (data.foto_operador) {
                                operadorFoto.innerHTML = `<img src="/uploads/${data.foto_operador}" alt="Foto de ${data.operador}">`;
                            } else {
                                operadorFoto.innerHTML = '<div class="avatar-placeholder">üë§</div>';
                            }
                        }
                    } else {
                        console.log('Nenhum operador ativo');
                        if (operadorCard) operadorCard.style.display = 'none';
                    }
                    
                    // Toca o som e l√™ a senha APENAS quando for uma nova senha
                    if (novaSenha && senhaAtual !== 'Nenhuma' && senhaAtual !== 'Aguardando pr√≥xima senha...' && senhaAtual !== 'Setor n√£o selecionado.') {
                        console.log('üéµ Nova senha detectada! Senha:', senhaAtual);
                        console.log('   √öltima senha conhecida:', ultimaSenhaConhecida);
                        console.log('   √â uma nova senha?', novaSenha);
                        
                        // Tocar o som
                        tocarSomSenha();
                        
                        // Ler a senha em voz alta
                        console.log('üîä Lendo senha em voz alta:', senhaAtual);
                        lerSenha(senhaAtual);
                    } else if (novaSenha) {
                        console.log('‚ö†Ô∏è Nova senha detectada, mas n√£o √© uma senha v√°lida:', senhaAtual);
                    } else {
                        console.log('‚ÑπÔ∏è Mesma senha ou aguardando, n√£o tocando som nem lendo');
                        console.log('   Senha atual:', senhaAtual);
                        console.log('   √öltima senha conhecida:', ultimaSenhaConhecida);
                    }
                    
                    // Atualizar a √∫ltima senha conhecida
                    ultimaSenhaConhecida = senhaAtual;
                })
                .catch(error => {
                    console.error('Erro ao atualizar senha:', error);
                    var senhaElement = document.getElementById('senha_atual');
                    if (senhaElement) {
                        senhaElement.innerText = 'Erro';
                    }
                })
                .finally(() => {
                    atualizandoSenhaAtual = false;
                });
        }
        
        // Vari√°vel para controlar se j√° est√° atualizando
        let atualizandoSenhaAtual = false;
        
        // Atualizar imediatamente
        atualizarSenhaAtual();
        
        // Atualizar a cada 10 segundos (reduzido de 5 para 10)
        setInterval(function() {
            if (!atualizandoSenhaAtual) {
                atualizarSenhaAtual();
            }
        }, 10000);
        
        // Atualiza√ß√£o instant√¢nea via Socket.IO
        const socket = io();
        socket.on('connect', function() {
            console.log('Socket.IO conectado em senha_atual.html');
        });
        
        socket.on('atualizar_lista', function() {
            console.log('Evento atualizar_lista recebido');
            atualizarSenhaAtual();
        });
        
        socket.on('nova_senha_para_avaliacao', function() {
            console.log('Evento nova_senha_para_avaliacao recebido');
            atualizarSenhaAtual();
        });
        
        socket.on('atualizar_atendimentos', function() {
            console.log('Evento atualizar_atendimentos recebido');
            atualizarSenhaAtual();
        });
    </script>
</body>
</html>
